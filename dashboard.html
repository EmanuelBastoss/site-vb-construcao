<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - VB Materiais</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; }
        h1, h2, h3, .font-montserrat { font-family: 'Montserrat', sans-serif; }
   
        #edit-modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
            transition: opacity 0.3s ease;
        }
        #edit-modal-content {
            transition: all 0.3s ease;
            max-height: 90vh; 
        }
    </style>
</head>
<body class="bg-gray-100">

    <section id="login-section" class="flex items-center justify-center min-h-screen">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md mx-auto">
            <h2 class="text-3xl font-bold text-blue-900 text-center mb-6">Acesso Restrito</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="admin-password" class="block text-gray-700 font-medium mb-2">Senha de Administrador</label>
                    <input type="password" id="admin-password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-400" required>
                </div>
                <button type="submit" id="login-button" class="w-full bg-blue-800 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-900 transition duration-300">
                    Entrar
                </button>
                <p id="login-status" class="text-center text-red-500 mt-4"></p>
            </form>
        </div>
    </section>

    <main id="dashboard-content" class="container mx-auto p-4 sm:p-8 hidden">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-blue-900">Dashboard Administrativo</h1>
            <p class="text-gray-600">Gestão de mensagens e cadastro de produtos.</p>
            
            <a href="index.html" class="mt-4 inline-block bg-blue-800 text-white font-bold py-2 px-4 rounded-lg shadow hover:bg-blue-900 transition duration-300">
                &larr; Voltar para o Site
            </a>
        </header>

        <section id="dashboard-admin" class="bg-white p-6 md:p-8 rounded-xl shadow-lg mb-12 max-w-4xl mx-auto">
            <h2 class="text-2xl font-bold text-blue-900 mb-6 border-b-2 border-amber-400 pb-2">Cadastrar Novo Produto</h2>
            
            <form id="product-form">
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <div class="mb-4">
                            <label for="name" class="block text-gray-700 font-medium mb-2">Nome do Produto</label>
                            <input type="text" id="name" name="name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-400" required>
                        </div>
                        <div class="mb-4">
                            <label for="price" class="block text-gray-700 font-medium mb-2">Preço (Ex: 120.50)</label>
                            <input type="number" id="price" name="price" step="0.01" min="0" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-400" required placeholder="R$">
                        </div>
                        <div class="mb-4">
                            <label for="category" class="block text-gray-700 font-medium mb-2">Categoria</label>
                            <select id="category" name="category" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-amber-400" required>
                                <option value="" disabled selected>Selecione uma categoria</option>
                                <option value="Fundação">Fundação</option>
                                <option value="Acabamento">Acabamento</option>
                                <option value="Hidráulica">Hidráulica</option>
                                <option value="Elétrica">Elétrica</option>
                                <option value="Ferramentas">Ferramentas</option>
                                <option value="Ferragem">Ferragem</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <div class="mb-4">
                            <label for="description" class="block text-gray-700 font-medium mb-2">Descrição</label>
                            <textarea id="description" name="description" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-400" required></textarea>
                        </div>
                        <div class="mb-4">
                            <label for="photo" class="block text-gray-700 font-medium mb-2">Foto do Produto</label>
                            <input type="file" id="photo" name="photo" accept="image/png, image/jpeg, image/gif, image/webp" class="w-full text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-100 file:text-blue-800 hover:file:bg-blue-200" required>
                        </div>
                    </div>
                </div>

                <div class="mt-6 text-right">
                    <button type="submit" class="bg-amber-400 text-blue-900 font-bold py-3 px-8 rounded-lg shadow-md hover:bg-amber-500 transition duration-300 transform hover:scale-105">
                        Cadastrar Produto
                    </button>
                </div>
                <p id="product-form-status" class="text-center mt-4"></p>
            </form>
        </section>

        <section class="bg-white p-6 md:p-8 rounded-xl shadow-lg mb-12">
            <h2 class="text-2xl font-bold text-blue-900 mb-6 border-b-2 border-amber-400 pb-2">Produtos Cadastrados</h2>
            <div id="products-list-container" class="overflow-x-auto">
                <p class="text-center text-gray-500 p-8">Carregando produtos...</p>
            </div>
        </section>

    
        <h2 class="text-2xl font-bold text-blue-900 mb-4">Mensagens Recebidas</h2>
        <div class="bg-white rounded-lg shadow overflow-x-auto">
            <table class="w-full text-left">
                <thead class="bg-gray-50 border-b">
                    <tr>
                        <th class="p-4 font-semibold text-gray-700">Data de Envio</th>
                        <th class="p-4 font-semibold text-gray-700">Nome</th>
                        <th class="p-4 font-semibold text-gray-700">Contato (Email/Tel)</th>
                        <th class="p-4 font-semibold text-gray-700">Mensagem</th>
                    </tr>
                </thead>
                <tbody id="messages-body">
                    <tr><td colspan="4" class="text-center p-8 text-gray-500">Carregando mensagens...</td></tr>
                </tbody>
            </table>
        </div>
    </main>



    <div id="edit-modal-backdrop" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden" onclick="closeEditModal()">
        <div id="edit-modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-3xl overflow-y-auto" onclick="event.stopPropagation()">

            <div class="flex justify-between items-center p-6 border-b">
                <h3 class="text-2xl font-bold text-blue-900">Editar Produto</h3>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600 text-3xl font-bold">&times;</button>
            </div>

         
            <form id="edit-product-form" class="p-6">
                <input type="hidden" id="edit-product-id" name="id">
                <h4 class="text-lg font-semibold text-gray-800 mb-4">Editar Informações</h4>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <div class="mb-4">
                            <label for="edit-name" class="block text-gray-700 font-medium mb-2">Nome</label>
                            <input type="text" id="edit-name" name="name" class="w-full px-4 py-3 border border-gray-300 rounded-lg" required>
                        </div>
                        <div class="mb-4">
                            <label for="edit-price" class="block text-gray-700 font-medium mb-2">Preço</label>
                            <input type="number" id="edit-price" name="price" step="0.01" min="0" class="w-full px-4 py-3 border border-gray-300 rounded-lg" required>
                        </div>
                        <div class="mb-4">
                            <label for="edit-category" class="block text-gray-700 font-medium mb-2">Categoria</label>
                            <select id="edit-category" name="category" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white" required>
                                <option value="Fundação">Fundação</option>
                                <option value="Acabamento">Acabamento</option>
                                <option value="Hidráulica">Hidráulica</option>
                                <option value="Elétrica">Elétrica</option>
                                <option value="Ferramentas">Ferramentas</option>
                                <option value="Ferragem">Ferragem</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <div class="mb-4">
                            <label for="edit-description" class="block text-gray-700 font-medium mb-2">Descrição</label>
                            <textarea id="edit-description" name="description" rows="10" class="w-full px-4 py-3 border border-gray-300 rounded-lg" required></textarea>
                        </div>
                    </div>
                </div>
                <div class="mt-4 text-right">
                    <button type="submit" class="bg-blue-800 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-900">
                        Salvar Alterações
                    </button>
                </div>
                <p id="edit-product-form-status" class="text-center mt-4"></p>
            </form>

          
            <form id="edit-photo-form" class="p-6 border-t">
                <h4 class="text-lg font-semibold text-gray-800 mb-4">Atualizar Foto</h4>
                <div class="flex items-center space-x-4">
                    <img id="edit-current-photo" src="" alt="Foto Atual" class="w-20 h-20 object-cover rounded-lg bg-gray-200" onerror="this.onerror=null; this.src='https://placehold.co/100x100/e0e0e0/999999?text=Sem+Foto';">
                    <input type="file" id="newPhoto" name="newPhoto" accept="image/png, image/jpeg, image/gif, image/webp" class="w-full text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-100 file:text-blue-800 hover:file:bg-blue-200" required>
                </div>
                <div class="mt-4 text-right">
                    <button type="submit" class="bg-amber-400 text-blue-900 font-bold py-3 px-6 rounded-lg shadow-md hover:bg-amber-500">
                        Atualizar Foto
                    </button>
                </div>
                <p id="edit-photo-form-status" class="text-center mt-4"></p>
            </form>
        </div>
    </div>



    <script>
     
        const ADMIN_PASSWORD = "vb_admin_2025"; 
    
        const API_URL = 'http://localhost:5000';
        const loginSection = document.getElementById('login-section');
        const dashboardContent = document.getElementById('dashboard-content');
        const loginForm = document.getElementById('login-form');
        const passwordInput = document.getElementById('admin-password');
        const loginStatus = document.getElementById('login-status');


        function showDashboard() {
            loginSection.classList.add('hidden');
            dashboardContent.classList.remove('hidden');
            
         
            fetchAndDisplayMessages();
            fetchAndDisplayProducts();
        }

     
       
        function handleLogin(event) {
            event.preventDefault();
            const pass = passwordInput.value;

            if (pass === ADMIN_PASSWORD) {
               
                sessionStorage.setItem('isLoggedIn', 'true'); 
                showDashboard();
            } else {
            
                loginStatus.textContent = 'Senha incorreta. Tente novamente.';
                passwordInput.value = '';
            }
        }
        
    
        function formatPrice(price) {
            if (typeof price !== 'number') price = 0;
            return price.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

  
       
        async function handleProductSubmit(event) {
            event.preventDefault();
            const productForm = document.getElementById('product-form');
            const formStatus = document.getElementById('product-form-status');
            const submitButton = productForm.querySelector('button[type="submit"]');

            submitButton.disabled = true;
            submitButton.textContent = 'Enviando...';
            formStatus.textContent = '';
            formStatus.style.color = 'inherit';

            const formData = new FormData(productForm);

            try {
                const response = await fetch(`${API_URL}/api/products`, {
                    method: 'POST',
                    body: formData 
                });
                const result = await response.json();

                if (response.ok) {
                    formStatus.textContent = '✅ Produto cadastrado com sucesso!';
                    formStatus.style.color = 'green';
                    productForm.reset();
                    fetchAndDisplayProducts();
                } else {
                    formStatus.textContent = `❌ Erro: ${result.error || 'Não foi possível cadastrar o produto.'}`;
                    formStatus.style.color = 'red';
                }
            } catch (error) {
                console.error('Erro de conexão:', error);
                formStatus.textContent = '❌ Erro de conexão. Verifique sua internet e o backend.';
                formStatus.style.color = 'red';
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Cadastrar Produto';
            }
        }

     
        async function fetchAndDisplayMessages() {
            const tbody = document.getElementById('messages-body');
            try {
                const response = await fetch(`${API_URL}/api/contact/messages`); 
                if (!response.ok) throw new Error('Não foi possível carregar os dados.');

                const messages = await response.json();
                tbody.innerHTML = ''; 
                
                if (messages.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center p-8 text-gray-500">Nenhuma mensagem encontrada.</td></tr>';
                    return;
                }
                messages.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); 

                messages.forEach(message => {
                    const formattedDate = new Date(message.createdAt).toLocaleString('pt-BR');
                    const tableRow = ` 
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-4 text-gray-600 align-top">${formattedDate}</td>
                            <td class="p-4 font-medium text-gray-800 align-top">${message.name}</td>
                            <td class="p-4 text-gray-600 align-top">${message.contact}</td> 
                            <td class="p-4 text-gray-600 max-w-sm whitespace-pre-wrap align-top">${message.message}</td>
                        </tr>
                    `;
                    tbody.innerHTML += tableRow; 
                });

            } catch (error) {
                console.error('Erro:', error);
                tbody.innerHTML = `<tr><td colspan="4" class="text-center p-8 text-red-500">Erro ao carregar mensagens. Verifique se o servidor está rodando.</td></tr>`;
            }
        }

        
        async function fetchAndDisplayProducts() {
            const container = document.getElementById('products-list-container');
            container.innerHTML = '<p class="text-center text-gray-500 p-8">Carregando produtos...</p>';

            try {
                const response = await fetch(`${API_URL}/api/products`); 
                if (!response.ok) throw new Error('Falha ao buscar produtos.');

                const products = await response.json();
                
                if (products.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500 p-8">Nenhum produto cadastrado ainda.</p>';
                    return;
                }
                
                products.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); 


                let tableHTML = `
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="p-4 font-semibold text-gray-700">Foto</th>
                                <th class="p-4 font-semibold text-gray-700">Nome</th>
                                <th class="p-4 font-semibold text-gray-700">Preço</th>
                                <th class="p-4 font-semibold text-gray-700">Categoria</th>
                                <th class="p-4 font-semibold text-gray-700">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                products.forEach(product => {
                    const imageURL = `${API_URL}${product.photoURL}`;
                    tableHTML += `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-4"><img src="${imageURL}" alt="${product.name}" class="w-16 h-16 object-cover rounded-md bg-gray-200" onerror="this.onerror=null; this.src='https://placehold.co/100x100/e0e0e0/999999?text=Sem+Foto';"></td>
                            <td class="p-4 font-medium text-gray-800">${product.name}</td>
                            <td class="p-4 text-gray-600">${formatPrice(product.price)}</td>
                            <td class="p-4 text-gray-600">${product.category}</td>
                            <td class="p-4 space-x-2">
                                <button onclick="openEditModal('${product._id}')" class="text-sm bg-blue-100 text-blue-800 font-semibold py-1 px-3 rounded-lg hover:bg-blue-200">Editar</button>

                                <button onclick="handleDeleteProduct('${product._id}')" class="text-sm bg-red-100 text-red-800 font-semibold py-1 px-3 rounded-lg hover:bg-red-200">Deletar</button>
                            </td>
                        </tr>
                    `;
                });

                tableHTML += '</tbody></table>';
                container.innerHTML = tableHTML;

            } catch (error) {
                console.error('Erro ao listar produtos:', error);
                container.innerHTML = `<p class="text-center text-red-500 p-8">Erro ao carregar produtos. Verifique se o servidor está rodando.</p>`;
            }
        }

      
        async function openEditModal(productId) {
            const modal = document.getElementById('edit-modal-backdrop');
            const formStatus = document.getElementById('edit-product-form-status');
            const photoStatus = document.getElementById('edit-photo-form-status');

            formStatus.textContent = '';
            photoStatus.textContent = '';

            try {
               
                const response = await fetch(`${API_URL}/api/products/${productId}`);
                if (!response.ok) throw new Error('Produto não encontrado.');
                
                const product = await response.json();

            
                document.getElementById('edit-product-id').value = product._id;
                document.getElementById('edit-name').value = product.name;
                document.getElementById('edit-price').value = product.price;
                document.getElementById('edit-category').value = product.category;
                document.getElementById('edit-description').value = product.description;

                document.getElementById('edit-current-photo').src = `${API_URL}${product.photoURL}`;

          
                modal.classList.remove('hidden');
                modal.classList.add('flex');

            } catch (error) {
                console.error('Erro ao abrir modal:', error);
                alert('Não foi possível carregar os dados do produto.');
            }
        }


        function closeEditModal() {
            const modal = document.getElementById('edit-modal-backdrop');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

    
        async function handleEditProductSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const formStatus = document.getElementById('edit-product-form-status');
            const submitButton = form.querySelector('button[type="submit"]');
            const productId = document.getElementById('edit-product-id').value;
            
            submitButton.disabled = true;
            submitButton.textContent = 'Salvando...';
            formStatus.textContent = '';

            const formData = {
                name: document.getElementById('edit-name').value,
                price: document.getElementById('edit-price').value,
                category: document.getElementById('edit-category').value,
                description: document.getElementById('edit-description').value,
            };

            try {
                const response = await fetch(`${API_URL}/api/products/${productId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                const result = await response.json();

                if (response.ok) {
                    formStatus.textContent = '✅ Dados salvos com sucesso!';
                    formStatus.style.color = 'green';
                    fetchAndDisplayProducts(); 
                } else {
                    formStatus.textContent = `❌ Erro: ${result.error || 'Não foi possível salvar.'}`;
                    formStatus.style.color = 'red';
                }
            } catch (error) {
                console.error('Erro ao salvar:', error);
                formStatus.textContent = '❌ Erro de conexão.';
                formStatus.style.color = 'red';
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Salvar Alterações';
            }
        }

     
        async function handleEditPhotoSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const formStatus = document.getElementById('edit-photo-form-status');
            const submitButton = form.querySelector('button[type="submit"]');
            const productId = document.getElementById('edit-product-id').value;
            const photoInput = document.getElementById('newPhoto');

            if (!photoInput.files || photoInput.files.length === 0) {
                formStatus.textContent = 'Por favor, selecione uma nova foto.';
                formStatus.style.color = 'red';
                return;
            }

            submitButton.disabled = true;
            submitButton.textContent = 'Enviando...';
            formStatus.textContent = '';

            const formData = new FormData();
            formData.append('newPhoto', photoInput.files[0]);

            try {
                const response = await fetch(`${API_URL}/api/products/${productId}/photo`, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (response.ok) {
                    formStatus.textContent = '✅ Foto atualizada com sucesso!';
                    formStatus.style.color = 'green';
                    document.getElementById('edit-current-photo').src = `${API_URL}${result.photoURL}?t=${new Date().getTime()}`; // Cache buster
                    form.reset();
                    fetchAndDisplayProducts(); 
                } else {
                    formStatus.textContent = `❌ Erro: ${result.error || 'Não foi possível enviar a foto.'}`;
                    formStatus.style.color = 'red';
                }
            } catch (error) {
                console.error('Erro ao enviar foto:', error);
                formStatus.textContent = '❌ Erro de conexão.';
                formStatus.style.color = 'red';
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Atualizar Foto';
            }
        }

        async function handleDeleteProduct(productId) {
            if (!window.confirm('Tem certeza que deseja deletar este produto? Esta ação não pode ser desfeita.')) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/products/${productId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();

                if (response.ok) {
                    alert('Produto deletado com sucesso.'); 
                    fetchAndDisplayProducts(); 
                } else {
                    alert(`Erro: ${result.error || 'Não foi possível deletar o produto.'}`);
                }
            } catch (error) {
                console.error('Erro ao deletar:', error);
                alert('Erro de conexão ao tentar deletar.');
            }
        }


        document.addEventListener('DOMContentLoaded', () => {
            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                showDashboard();
            }

            loginForm.addEventListener('submit', handleLogin);
            
            const productForm = document.getElementById('product-form');
            productForm.addEventListener('submit', handleProductSubmit);

            const editProductForm = document.getElementById('edit-product-form');
            editProductForm.addEventListener('submit', handleEditProductSubmit);
            
            const editPhotoForm = document.getElementById('edit-photo-form');
            editPhotoForm.addEventListener('submit', handleEditPhotoSubmit);

            
        });
    </script>

</body>
</html>

